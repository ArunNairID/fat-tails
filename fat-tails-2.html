<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Fat Tails</title>
  <link rel="stylesheet" type="text/css" href="fat-tails.css">
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">

</head>
<body>
<p> p-value slider</p>
<div id="pslider"></div>
<p> a-value slider</p>
<div id="aslider"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript">

// A formatter for counts.
var formatCount = d3.format(",.0f");

var m = {top: 10, right: 30, bottom: 30, left: 50},
    width = 960 - m.left - m.right,
    height = 500 - m.top - m.bottom;

var xdomain = [-5,5]

var x = d3.scale.linear()
    .domain(xdomain)
    .range([0, width]);

// Generate a histogram using twenty uniformly-spaced bins.
function ft(p, a){
  var n = 35000;
  var b = Math.sqrt((1 - p * Math.pow(a, 2))/(1-p));
  var x = [];
  d3.range(n).map(function(d){
    if (Math.random() <= p){
        x.push(a*d3.random.normal(0,1)());
    }else{
        x.push(b*d3.random.normal(0,1)());
    };
  });
  return x
};

p = .8
a = .4

var values = ft(p, a);

// var values = d3.range(25000).map(d3.random.normal(0,1));

var data = d3.layout.histogram()
    .bins(x.ticks(80))
    .range(x.domain())
    .frequency(false)
    (values);

var y = d3.scale.linear()
    .domain([0, d3.max(data, function(d) { return d.y; })])
    .range([height, 0]);

var color = d3.scale.linear()
  .domain([1,100])
  .range(['blue', 'yellow'])
  .interpolate(d3.interpolateHcl)

var yAxis = d3.svg.axis()
    .scale(y)
    .orient('left')

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var svg = d3.select("body").append("svg").classed('histogram',true)
    .attr("width", width + m.left + m.right)
    .attr("height", height + m.top + m.bottom)
  .append("g")
    .attr("transform", "translate(" + m.left + "," + m.top + ")");

var bar = svg.selectAll(".bar")
    .data(data)
  .enter().append("g")
    .attr("class", "bar")
    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });

bar.append("rect")
    .attr("x", 1)
    .attr("width", x(data[0].dx + x.domain()[0]) - 2 )
    .attr("height", function(d) { return height - y(d.y); })
    .style("fill", function(d,i){return color(i); });

svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

svg.append("g")
    .attr("class", "y axis")
    .attr("transform", "translate(" + 0 + ",0)")
    .call(yAxis);

function redraw(input, which) {
    if(which === "p"){ p = input}
      else { a = input}
    values = ft(p ,a);
    data = d3.layout.histogram()
      .bins(x.ticks(80))
      .range(x.domain())
      .frequency(false)
        (values);

    y.domain([0, d3.max(data, function(d) { return d.y; })])
    
    d3.select(".y.axis").transition().duration(400).call(yAxis).ease('quad');

    d3.selectAll('.bar').data(data)
      .transition().duration(300).ease('cube')
      .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });
    d3.selectAll('rect').data(data)
      .transition().duration(300).ease('quad')
      .attr("height", function(d) { return height - y(d.y); });
};

/*todo: 
print "expected time until extreme event"
let users modify the speed
line
make labels for sliders
print kurtosis on there
make a title
color the bars by the shade
whenever there's a change in paramters, draw a dividing line on the plot
add css for the plot elements
*/

$("#pslider")
      .css({"margin-top": 10 + "px",
        "margin-left": m.left,
        "width": width
      })
      .slider({
        "range": false,
        "step": .05,
        "min": 0,
        "max": 1,
        "value":p,
        "stop": function(event, ui) {
          redraw(ui.value, "p");
         }
      }) //add another slider

$("#aslider")
      .css({"margin-top": 20 + "px",
        "margin-left": m.left,
        "width": width
      })
      .slider({
        "range": false,
        "step": .05,
        "min": 0,
        "max": 1,
        "value":a,
        "stop": function(event, ui) {
          redraw(ui.value, "a");
         }
      }) //add another slider



var h2 = height - 250

var svg2 = d3.select("body").append("svg")
    .classed('market', true)
    .attr("width", width + m.left + m.right)
    .attr("height", h2)
  .append("g")
    .attr("transform", "translate(" + m.left + "," + m.top + ")");

var y2 = d3.scale.linear()
    .domain(xdomain)
    .range([0, h2]);

var x2 = d3.scale.linear()
    .domain([0, 50])
    .range([0,width])

var plotData = d3.range(50).map(function(){return change()})

var yAxis2 = d3.svg.axis()
    .scale(y2)
    .tickSize(-width)
    .orient('left')

var xAxis2 = d3.svg.axis()
    .scale(x2)
    .orient("bottom");


svg2.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis2);

svg2.append("g")
    .attr("class", "y axis")
    .attr("transform", "translate(" + 0 + ",0)")
    .call(yAxis2);


var line = d3.svg.line()
    .x(function(d,i) { return x2(i); })
    .y(function(d) { return y2(d.val); });

function change(){
  var t = values[ Math.round(Math.random() * values.length) ]
  var col = d3.selectAll('.bar rect')[0]
    .filter(function(d){ 
      var r =  d.__data__
      return r.x < t && t < r.x + r.dx 
    })[0].style.fill
  return {val: t, fill: col};
};

// var path = svg2.append("path")
//       .datum(plotData)
//     .attr("class", "line")
//     .attr("fill", "none")
//     .attr("stroke", "black")
//     .attr("d", line);

setInterval(function(){
  plotData.shift();

  plotData.push(change());

  
  // path.datum(plotData).transition().duration(100).attr("d", line)

  var circle = svg2.selectAll("circle")
    .data(plotData, function(d) {return d.val});

  circle.enter()
    .append('circle')
    .attr({
      r: 4,
      fill: function(d){return d.fill},
      cx: function(d,i){return x2(i)},
      cy: function(d){return y2(d.val)}
    });

  circle.transition().duration(100)
    .attr("cx", function(d,i){return x2(i)});

  circle.exit()
     .remove();


},100);

</script>